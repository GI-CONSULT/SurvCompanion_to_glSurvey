<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https://*.tile.openstreetmap.org https://*.tile.opentopomap.org https://server.arcgisonline.com; connect-src 'self'; font-src 'self'; object-src 'none'; base-uri 'self';">
  <title>SurvComp → gl-Survey Konverter</title>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js" integrity="sha256-SXX79BH6wYQsW5HTYtMj0/AcoMtSOFouohl5D/qiCoA=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" integrity="sha256-uOhwxdKyl3LxDJ+pppPIuJaqyFQO1nAePMYwTGg/69s=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" integrity="sha256-QZFpF9DkpabUBLoCc7fQJVCmtag/LaVAfAkUJSfuNyY=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" integrity="sha256-MgH13bFTTNqsnuEoqNPBLDaqxjGH+lCpqrukmXc8Ppg=" crossorigin="anonymous"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f1f5f9;
      --surface: #ffffff;
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --primary-light: #3b82f6;
      --primary-bg: #eff6ff;
      --success: #059669;
      --success-bg: #ecfdf5;
      --danger: #dc2626;
      --danger-bg: #fef2f2;
      --warning: #d97706;
      --warning-bg: #fffbeb;
      --text: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-focus: #93c5fd;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
      --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── Header ── */
    .header {
      background: linear-gradient(135deg, #0f2847 0%, #1e40af 50%, #2563eb 100%);
      color: white;
      padding: 2rem 2rem 2.5rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .header::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6);
    }
    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.025em;
      margin-bottom: 0.25rem;
    }
    .header h1 span { color: #93c5fd; font-weight: 400; }
    .header p {
      font-size: 0.925rem;
      color: #bfdbfe;
      font-weight: 400;
    }

    /* ── Main Layout ── */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
      .config-grid { grid-template-columns: 1fr; }
    }

    /* ── Card ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: box-shadow var(--transition);
    }
    .card:hover { box-shadow: var(--shadow-md); }
    .card-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    /* ── Upload Zone ── */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--primary-light);
      background: var(--primary-bg);
    }
    .upload-zone.has-file {
      border-color: var(--success);
      background: var(--success-bg);
      border-style: solid;
    }
    .upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 0.75rem;
      color: var(--text-muted);
      transition: color var(--transition);
    }
    .upload-zone:hover .upload-icon,
    .upload-zone.drag-over .upload-icon { color: var(--primary-light); }
    .upload-zone.has-file .upload-icon { color: var(--success); }
    .upload-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }
    .upload-text strong { color: var(--primary); }
    .upload-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }
    .file-info {
      display: none;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: var(--success-bg);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
    }
    .file-info.visible { display: flex; }
    .file-info .name { font-weight: 600; color: var(--text); }
    .file-info .meta { color: var(--text-secondary); }

    /* ── Settings ── */
    .form-group { margin-bottom: 1.25rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.4rem;
    }
    .form-select {
      width: 100%;
      padding: 0.65rem 2.5rem 0.65rem 0.85rem;
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M4.646 5.646a.5.5 0 0 1 .708 0L8 8.293l2.646-2.647a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      transition: border-color var(--transition), box-shadow var(--transition);
      cursor: pointer;
    }
    .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    .zone-hint {
      display: none;
      font-size: 0.8rem;
      color: var(--primary);
      margin-top: 0.4rem;
      padding: 0.4rem 0.65rem;
      background: var(--primary-bg);
      border-radius: var(--radius-sm);
    }
    .zone-hint.visible { display: block; }

    /* ── Auto-detect zone button ── */
    .btn-detect {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.5rem;
      padding: 0.4rem 0.85rem;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: inherit;
      color: var(--primary);
      background: var(--primary-bg);
      border: 1.5px solid var(--border-focus);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
    }
    .btn-detect:hover:not(:disabled) { background: #dbeafe; border-color: var(--primary); }
    .btn-detect:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-detect svg { width: 14px; height: 14px; flex-shrink: 0; }
    /* ── Delta / back-transform validation colours ── */
    .delta-ok   { color: var(--success); font-weight: 600; }
    .delta-warn { color: var(--warning); font-weight: 600; }
    .delta-err  { color: var(--danger);  font-weight: 600; }

    /* ── Code conversion ── */
    .code-select {
      padding: 0.2rem 0.4rem;
      font-size: 0.8rem;
      font-family: inherit;
      border: 1.5px solid var(--border);
      border-radius: 4px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }
    .code-select:focus { border-color: var(--border-focus); outline: none; }
    .art-original { color: var(--text-muted); font-size: 0.78rem; }
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .toggle-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    .toggle-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
    }
    .code-legend {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
      line-height: 1.5;
    }
    .sep-conflict {
      display: none;
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 0.35rem;
      padding: 0.35rem 0.65rem;
      background: var(--danger-bg);
      border-radius: var(--radius-sm);
    }
    .sep-conflict.visible { display: block; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.7rem 1.5rem;
      font-size: 0.925rem;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
      text-decoration: none;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      width: 100%;
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      box-shadow: 0 2px 4px rgba(30, 64, 175, 0.25);
    }
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-hover), #1e3a8a);
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.35);
      transform: translateY(-1px);
    }
    .btn-primary:active:not(:disabled) { transform: translateY(0); }
    .btn-success {
      color: white;
      background: linear-gradient(135deg, var(--success), #047857);
      box-shadow: 0 2px 4px rgba(5, 150, 105, 0.25);
      padding: 0.85rem 2rem;
      font-size: 1rem;
    }
    .btn-success:hover {
      box-shadow: 0 4px 8px rgba(5, 150, 105, 0.35);
      transform: translateY(-1px);
    }

    /* ── Spinner ── */
    .spinner {
      width: 18px;
      height: 18px;
      border: 2.5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Results ── */
    .results-section {
      display: none;
      animation: fadeIn 0.35s ease;
    }
    .results-section.visible { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stats-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.85rem;
      background: var(--primary-bg);
      color: var(--primary);
      border-radius: 999px;
      font-size: 0.825rem;
      font-weight: 600;
    }
    .stat-chip svg { width: 14px; height: 14px; }

    .table-card {
      overflow: hidden;
      padding: 0;
    }
    .table-wrapper {
      overflow-x: auto;
      max-height: 520px;
      overflow-y: auto;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table th {
      background: #f8fafc;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 2px solid var(--border);
    }
    .data-table td {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text);
    }
    .data-table tbody tr:hover { background: #f8fafc; }
    .data-table tbody tr:nth-child(even) { background: #fafbfc; }
    .data-table tbody tr:nth-child(even):hover { background: #f1f5f9; }
    .data-table .num { font-variant-numeric: tabular-nums; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-size: 0.825rem; }

    .actions-bar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    /* ── Alerts ── */
    .alert {
      display: none;
      padding: 0.85rem 1.15rem;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      margin-bottom: 1.25rem;
      border: 1px solid;
    }
    .alert.visible { display: flex; align-items: center; gap: 0.5rem; }
    .alert-error {
      background: var(--danger-bg);
      border-color: #fecaca;
      color: var(--danger);
    }
    .alert-warning {
      background: var(--warning-bg);
      border-color: #fde68a;
      color: var(--warning);
    }

    /* ── Map ── */
    .map-card {
      margin-top: 1.5rem;
    }
    .map-card .card-title { padding: 1.25rem 1.5rem 0; }
    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem 0;
      margin-bottom: 0.75rem;
    }
    .map-header .card-title { padding: 0; margin: 0; }
    #mapContainer {
      height: 480px;
      border-radius: 0 0 var(--radius) var(--radius);
      overflow: hidden;
    }
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 0.85rem;
    }
    .leaflet-popup-content { margin: 10px 14px; }
    .popup-title {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--primary);
      margin-bottom: 6px;
    }
    .popup-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }
    .popup-row span:last-child {
      font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
      font-size: 0.8rem;
      color: var(--text);
    }
    .map-tiles-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.75rem;
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-secondary);
      transition: all var(--transition);
    }
    .map-tiles-btn:hover { border-color: var(--primary-light); color: var(--primary); }
    .map-tiles-btn.active { background: var(--primary-bg); border-color: var(--primary-light); color: var(--primary); }

    /* ── Rail overlay toggle ── */
    .map-overlay-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.75rem;
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-secondary);
      transition: all var(--transition);
    }
    .map-overlay-btn:hover { border-color: var(--danger); color: var(--danger); }
    .map-overlay-btn.active { background: #fef2f2; border-color: var(--danger); color: var(--danger); }

    /* ── Footer ── */
    .footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    .footer a { color: var(--primary-light); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<header class="header">
  <h1>SurvComp <span>→</span> gl-Survey</h1>
  <p>Koordinatenkonverter &middot; WGS 84 → Gauß-Krüger (DB_REF)</p>
</header>

<main class="main">
  <div id="alert" class="alert" role="alert">
    <span id="alertText"></span>
  </div>

  <div class="config-grid">
    <!-- Upload Card -->
    <div class="card">
      <div class="card-title">1. CSV-Datei wählen</div>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".csv,text/csv" title="CSV-Datei auswählen" aria-label="CSV-Datei auswählen">
        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <div class="upload-text"><strong>CSV-Datei</strong> hier ablegen oder klicken</div>
        <div class="upload-hint">Erwartet: vermessungspunkte.csv aus SurvComp</div>
      </div>
      <div class="file-info" id="fileInfo">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <div>
          <div class="name" id="fileName"></div>
          <div class="meta" id="fileMeta"></div>
        </div>
      </div>
    </div>

    <!-- Settings Card -->
    <div class="card">
      <div class="card-title">2. Zielkoordinatensystem</div>
      <div class="form-group">
        <label class="form-label" for="epsgSelect">EPSG-Code / GK-Zone</label>
        <select class="form-select" id="epsgSelect">
          <option value="5681">EPSG:5681 — DB_REF / GK Zone 1 (Mittelmeridian 3°)</option>
          <option value="5682">EPSG:5682 — DB_REF / GK Zone 2 (Mittelmeridian 6°)</option>
          <option value="5683" selected>EPSG:5683 — DB_REF / GK Zone 3 (Mittelmeridian 9°)</option>
          <option value="5684">EPSG:5684 — DB_REF / GK Zone 4 (Mittelmeridian 12°)</option>
          <option value="5685">EPSG:5685 — DB_REF / GK Zone 5 (Mittelmeridian 15°)</option>
        </select>
        <div class="zone-hint" id="zoneHint"></div>
        <button class="btn-detect" id="detectZoneBtn" disabled
          title="Optimale GK-Zone aus den WGS84-Koordinaten der geladenen Datei ermitteln">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/></svg>
          Zone auto-ermitteln
        </button>
      </div>

      <div class="form-group">
        <label class="form-label" for="separatorSelect">CSV-Trennzeichen</label>
        <select class="form-select" id="separatorSelect">
          <option value=";" selected>Semikolon ( ; )</option>
          <option value=",">Komma ( , )</option>
          <option value="\t">Tabulator</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="decimalSelect">Dezimaltrennzeichen</label>
        <select class="form-select" id="decimalSelect">
          <option value="." selected>Punkt ( . )</option>
          <option value=",">Komma ( , )</option>
        </select>
        <div class="sep-conflict" id="sepConflict">⚠ Spalten- und Dezimaltrennzeichen sind identisch! Beim Export wird das Spaltentrennzeichen automatisch auf Semikolon umgestellt.</div>
      </div>

      <div class="form-group">
        <div class="toggle-group">
          <input type="checkbox" id="codeConvertToggle" checked>
          <label for="codeConvertToggle">Punktcode-Konvertierung</label>
        </div>
        <div class="code-legend">
          PS0→100 · PS1→101 · PS2→102 · PS3→103 · LHP→116<br>
          PS4 / GVP / GVPV → 151, 153, 155, 171 <em>(wählbar pro Punkt)</em>
        </div>
      </div>

      <div class="form-group">
        <button class="btn btn-primary" id="convertBtn" disabled>
          <span id="convertBtnText">Konvertieren</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-section" id="resultsSection">
    <div class="stats-bar" id="statsBar"></div>

    <div class="card table-card">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Punktnummer</th>
              <th>Rechtswert</th>
              <th>Hochwert</th>
              <th>Höhe</th>
              <th>Art</th>
              <th>Bemerkung</th>
              <th class="num" style="min-width:60px" title="Rücktransformationsfehler: GK→WGS84 vs. Eingabe (mm)">Δ mm</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="actions-bar">
      <button class="btn btn-success" id="downloadBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        CSV herunterladen
      </button>
    </div>

    <!-- Map Viewer -->
    <div class="card map-card">
      <div class="map-header">
        <div class="card-title">Lageprüfung &mdash; Transformierte Punkte</div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <button class="map-tiles-btn active" id="btnOsm">OSM</button>
          <button class="map-tiles-btn" id="btnSat">Satellit</button>
          <button class="map-tiles-btn" id="btnTopo">Topo</button>
          <span style="width:1px;height:20px;background:var(--border);margin:0 0.25rem;"></span>
          <button class="map-overlay-btn" id="btnRail" title="DB-Streckennetz ein-/ausblenden">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
            Streckennetz
          </button>
        </div>
      </div>
      <div id="mapContainer"></div>
    </div>
  </div>
</main>

<footer class="footer">
  <a href="https://github.com/GI-CONSULT/SurvCompanion_to_glSurvey" target="_blank" rel="noopener">SurvComp → gl-Survey Konverter</a> &middot; Koordinatentransformation via <a href="https://github.com/proj4js/proj4js" target="_blank" rel="noopener">proj4js</a>
</footer>

<script>
(() => {
  'use strict';

  // ── Proj4 Definitions (DB_REF / 3-degree Gauss-Krüger) ──
  const EPSG_DEFS = {
    5681: { zone: 1, cm: 3,  proj4: '+proj=tmerc +lat_0=0 +lon_0=3  +k=1 +x_0=1500000 +y_0=0 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
    5682: { zone: 2, cm: 6,  proj4: '+proj=tmerc +lat_0=0 +lon_0=6  +k=1 +x_0=2500000 +y_0=0 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
    5683: { zone: 3, cm: 9,  proj4: '+proj=tmerc +lat_0=0 +lon_0=9  +k=1 +x_0=3500000 +y_0=0 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
    5684: { zone: 4, cm: 12, proj4: '+proj=tmerc +lat_0=0 +lon_0=12 +k=1 +x_0=4500000 +y_0=0 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
    5685: { zone: 5, cm: 15, proj4: '+proj=tmerc +lat_0=0 +lon_0=15 +k=1 +x_0=5500000 +y_0=0 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
  };

  // Register all EPSG codes with proj4
  for (const [code, def] of Object.entries(EPSG_DEFS)) {
    proj4.defs(`EPSG:${code}`, def.proj4);
  }

  // ── Point code mapping (Art → numeric code for gl-Survey) ──
  const CODE_MAP = {
    'PS0':  [100],
    'PS1':  [101],
    'PS2':  [102],
    'PS3':  [103],
    'PS4':  [151, 153, 155, 171],
    'LHP':  [116],
    'GVP':  [151, 153, 155, 171],
    'GVPV': [151, 153, 155, 171],
  };

  // ── State ──
  let parsedData = null;
  let convertedData = null;

  // ── DOM References ──
  const $ = id => document.getElementById(id);
  const uploadZone = $('uploadZone');
  const fileInput = $('fileInput');
  const fileInfo = $('fileInfo');
  const fileName = $('fileName');
  const fileMeta = $('fileMeta');
  const epsgSelect = $('epsgSelect');
  const separatorSelect = $('separatorSelect');
  const zoneHint = $('zoneHint');
  const convertBtn = $('convertBtn');
  const convertBtnText = $('convertBtnText');
  const resultsSection = $('resultsSection');
  const statsBar = $('statsBar');
  const tableBody = $('tableBody');
  const downloadBtn = $('downloadBtn');
  const detectZoneBtn = $('detectZoneBtn');
  const decimalSelect = $('decimalSelect');
  const codeConvertToggle = $('codeConvertToggle');
  const sepConflict = $('sepConflict');
  const alertEl = $('alert');
  const alertText = $('alertText');

  // ── Helpers ──
  function esc(str) {
    return String(str ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function showAlert(msg, type = 'error') {
    alertEl.className = `alert alert-${type} visible`;
    alertText.textContent = msg;
    setTimeout(() => { alertEl.classList.remove('visible'); }, 8000);
  }

  function hideAlert() {
    alertEl.classList.remove('visible');
  }

  function detectBestZone(rows) {
    let sumLon = 0, count = 0;
    for (const row of rows) {
      const lon = parseFloat(row.gps_longitude);
      if (!isNaN(lon)) { sumLon += lon; count++; }
    }
    if (count === 0) return null;
    const avgLon = sumLon / count;
    // Find zone whose central meridian is closest to avgLon
    let best = null, bestDist = Infinity;
    for (const [code, def] of Object.entries(EPSG_DEFS)) {
      const dist = Math.abs(avgLon - def.cm);
      if (dist < bestDist) { bestDist = dist; best = { epsg: Number(code), zone: def.zone, avgLon }; }
    }
    return best;
  }

  function formatCoord(val) {
    return val.toFixed(3);
  }

  function escapeCSVField(value, sep) {
    const str = String(value ?? '');
    if (str.includes(sep) || str.includes('"') || str.includes('\n') || str.includes('\r')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  }

  // ── File Upload ──
  function handleFile(file) {
    if (!file || !file.name.toLowerCase().endsWith('.csv')) {
      showAlert('Bitte eine CSV-Datei auswählen.');
      return;
    }

    hideAlert();
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
    if (file.size > MAX_FILE_SIZE) {
      showAlert(`Datei zu groß (${(file.size / 1024 / 1024).toFixed(1)} MB). Maximale Größe: 10 MB.`);
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const result = Papa.parse(text, {
        header: true,
        skipEmptyLines: 'greedy',
        dynamicTyping: false,
      });

      if (result.errors.length > 0 && result.data.length === 0) {
        showAlert('CSV konnte nicht gelesen werden: ' + result.errors[0].message);
        return;
      }

      // Validate critical columns (needed for coordinate transformation)
      const critical = ['punkt_id', 'gps_latitude', 'gps_longitude'];
      const headers = result.meta.fields || [];
      const missing = critical.filter(h => !headers.includes(h));
      if (missing.length > 0) {
        showAlert(`Fehlende Pflichtspalten: ${missing.join(', ')}. Ist das eine SurvComp-Datei?`);
        return;
      }

      // Hint about missing optional columns
      const optional = ['hoehe', 'art', 'bemerkungen'];
      const missingOpt = optional.filter(h => !headers.includes(h));
      if (missingOpt.length > 0) {
        showAlert(`Hinweis: Spalten ${missingOpt.join(', ')} fehlen — Standardwerte werden verwendet.`, 'warning');
      }

      parsedData = result.data.filter(row => row.punkt_id && row.punkt_id.trim());

      // Update UI
      uploadZone.classList.add('has-file');
      fileInfo.classList.add('visible');
      fileName.textContent = file.name;
      fileMeta.textContent = `${parsedData.length} Punkte erkannt · ${(file.size / 1024).toFixed(1)} KB`;
      convertBtn.disabled = false;
      detectZoneBtn.disabled = false;

      // Auto-detect zone
      const best = detectBestZone(parsedData);
      if (best) {
        epsgSelect.value = best.epsg;
        zoneHint.textContent = `Empfohlen: EPSG:${best.epsg} (Zone ${best.zone}) — Durchschnittslänge ${best.avgLon.toFixed(4)}°`;
        zoneHint.classList.add('visible');
      }

      // Reset results
      resultsSection.classList.remove('visible');
      convertedData = null;
    };
    reader.readAsText(file, 'UTF-8');
  }

  fileInput.addEventListener('change', (e) => {
    handleFile(e.target.files[0]);
  });

  // Drag & Drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
  });
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
  });
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    handleFile(file);
  });

  // ── Auto-detect zone button ──
  detectZoneBtn.addEventListener('click', () => {
    if (!parsedData) return;
    const best = detectBestZone(parsedData);
    if (best) {
      epsgSelect.value = best.epsg;
      zoneHint.textContent = `Empfohlen: EPSG:${best.epsg} (Zone ${best.zone}) — Durchschnittslänge ${best.avgLon.toFixed(4)}°`;
      zoneHint.classList.add('visible');
    }
  });

  // ── Separator conflict detection ──
  function checkSepConflict() {
    const colSep = separatorSelect.value;
    const decSep = decimalSelect.value;
    if (colSep === ',' && decSep === ',') {
      sepConflict.classList.add('visible');
    } else {
      sepConflict.classList.remove('visible');
    }
  }
  separatorSelect.addEventListener('change', checkSepConflict);
  decimalSelect.addEventListener('change', checkSepConflict);

  // ── Code conversion toggle → re-render table ──
  codeConvertToggle.addEventListener('change', () => {
    if (convertedData) renderTable(convertedData);
  });

  // ── Table rendering (extracted so code-toggle can re-render) ──
  function renderTable(results) {
    const useCode = codeConvertToggle.checked;
    const fragment = document.createDocumentFragment();
    results.forEach((r, i) => {
      const tr = document.createElement('tr');
      if (r.warn) tr.style.opacity = '0.5';

      let artHtml;
      if (useCode && r.codeOptions) {
        if (r.codeOptions.length === 1) {
          artHtml = `<span title="${esc(r.art)} → ${r.codeOptions[0]}">${r.codeOptions[0]}</span>`;
        } else {
          const opts = r.codeOptions.map(c =>
            `<option value="${c}"${c === r.selectedCode ? ' selected' : ''}>${c}</option>`
          ).join('');
          artHtml = `<span class="art-original">${esc(r.art)} →</span> <select class="code-select" data-idx="${i}">${opts}</select>`;
        }
      } else {
        artHtml = esc(r.art);
      }

      tr.innerHTML = `
        <td class="num">${i + 1}</td>
        <td><strong>${esc(r.punktnummer)}</strong></td>
        <td class="num">${esc(r.rechtswert)}</td>
        <td class="num">${esc(r.hochwert)}</td>
        <td class="num">${esc(r.hoehe)}</td>
        <td>${artHtml}</td>
        <td>${esc(r.bemerkung)}</td>
        <td class="num">${r.delta != null ? `<span class="${r.delta < 1 ? 'delta-ok' : r.delta < 10 ? 'delta-warn' : 'delta-err'}">${r.delta.toFixed(3)}</span>` : ''}</td>
      `;
      fragment.appendChild(tr);
    });
    tableBody.innerHTML = '';
    tableBody.appendChild(fragment);

    // Bind dropdown change handlers for multi-code types
    if (useCode) {
      tableBody.querySelectorAll('.code-select').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.idx);
          results[idx].selectedCode = parseInt(e.target.value);
        });
      });
    }
  }

  // ── Conversion ──
  convertBtn.addEventListener('click', () => {
    if (!parsedData) return;
    hideAlert();

    const epsgCode = epsgSelect.value;
    const targetProj = `EPSG:${epsgCode}`;
    const def = EPSG_DEFS[epsgCode];

    // Show spinner
    convertBtnText.innerHTML = '<span class="spinner"></span> Konvertiere…';
    convertBtn.disabled = true;

    // Use requestAnimationFrame to allow UI update before heavy computation
    requestAnimationFrame(() => {
      try {
        const results = [];
        let warnings = 0;
        let maxDelta = 0, sumDelta = 0, deltaCount = 0;

        for (const row of parsedData) {
          const lat = parseFloat(row.gps_latitude);
          const lon = parseFloat(row.gps_longitude);
          const hoehe = row.hoehe ? parseFloat(row.hoehe) : null;
          const bemerkung = (row.bemerkungen || '').trim().replace(/\r?\n/g, ' ');
          const artRaw = (row.art || '').trim();
          const artKey = artRaw.toUpperCase();
          const codeOpts = CODE_MAP[artKey] || null;
          const defaultCode = codeOpts ? codeOpts[codeOpts.length - 1] : null;

          if (isNaN(lat) || isNaN(lon)) {
            warnings++;
            results.push({
              punktnummer: row.punkt_id,
              rechtswert: '',
              hochwert: '',
              hoehe: hoehe != null && !isNaN(hoehe) ? hoehe : '',
              art: artRaw,
              bemerkung,
              warn: true,
              lat: null, lon: null,
              delta: null,
              codeOptions: codeOpts,
              selectedCode: defaultCode,
            });
            continue;
          }

          const [easting, northing] = proj4('EPSG:4326', targetProj, [lon, lat]);

          // Back-transform: GK → WGS84 for map display & round-trip validation
          const [backLon, backLat] = proj4(targetProj, 'EPSG:4326', [easting, northing]);
          const dN_m = (backLat - lat) * 111111;
          const dE_m = (backLon - lon) * 111111 * Math.cos(lat * Math.PI / 180);
          const delta_mm = Math.sqrt(dN_m * dN_m + dE_m * dE_m) * 1000;
          maxDelta = Math.max(maxDelta, delta_mm);
          sumDelta += delta_mm;
          deltaCount++;

          results.push({
            punktnummer: row.punkt_id,
            rechtswert: formatCoord(easting),
            hochwert: formatCoord(northing),
            hoehe: hoehe != null && !isNaN(hoehe) ? hoehe.toFixed(3) : '',
            art: artRaw,
            bemerkung,
            warn: false,
            lat, lon,
            backLat, backLon,
            delta: delta_mm,
            codeOptions: codeOpts,
            selectedCode: defaultCode,
          });
        }

        convertedData = results;

        // Render stats
        statsBar.innerHTML = `
          <span class="stat-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4m-10-10h4m12 0h4"/></svg>
            ${results.length} Punkte
          </span>
          <span class="stat-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>
            EPSG:${epsgCode} · Zone ${def.zone} · CM ${def.cm}°
          </span>
          ${warnings > 0 ? `<span class="stat-chip" style="background:var(--warning-bg);color:var(--warning);">⚠ ${warnings} ohne Koordinaten</span>` : ''}
          ${(() => {
            if (deltaCount === 0) return '';
            const avg = sumDelta / deltaCount;
            const cls = maxDelta < 1 ? 'success' : maxDelta < 10 ? 'warning' : 'danger';
            const icon = maxDelta < 1 ? '✓' : maxDelta < 10 ? '⚠' : '✗';
            const label = maxDelta < 1 ? 'Prüfung OK' : maxDelta < 10 ? 'Prüfung ⚠' : 'Prüfung ✗';
            return `<span class="stat-chip" title="Rücktransformationsfehler max/⌀ — zeigt Transformationsgenauigkeit" style="background:var(--${cls}-bg);color:var(--${cls});">${icon} ${label} · max ${maxDelta.toFixed(3)} mm · ⌀ ${avg.toFixed(3)} mm</span>`;
          })()}
        `;

        // Render table (code conversion may add dropdowns)
        renderTable(results);

        resultsSection.classList.add('visible');
        // Defer map render so browser has time to paint the (newly visible) container
        // before Leaflet measures its size
        setTimeout(() => renderMap(results, epsgCode), 60);

        if (warnings > 0) {
          showAlert(`${warnings} Punkt(e) hatten keine gültigen GPS-Koordinaten und wurden ohne Rechtswert/Hochwert übernommen.`, 'warning');
        }
      } catch (err) {
        showAlert('Fehler bei der Konvertierung: ' + err.message);
      } finally {
        convertBtnText.textContent = 'Konvertieren';
        convertBtn.disabled = false;
      }
    });
  });

  // ── Map ──
  let map = null;
  let markersLayer = null;
  const tileLayers = {};

  function initMap() {
    if (map) return;
    map = L.map('mapContainer', { zoomControl: true });

    tileLayers.osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" rel="noopener">OpenStreetMap</a> contributors', maxZoom: 20 }
    ).addTo(map);

    tileLayers.sat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP', maxZoom: 20 }
    );

    tileLayers.topo = L.tileLayer(
      'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; <a href="https://opentopomap.org" rel="noopener">OpenTopoMap</a>', maxZoom: 17 }
    );

    markersLayer = L.layerGroup().addTo(map);

    $('btnOsm').addEventListener('click', () => switchTiles('osm'));
    $('btnSat').addEventListener('click', () => switchTiles('sat'));
    $('btnTopo').addEventListener('click', () => switchTiles('topo'));
    $('btnRail').addEventListener('click', toggleRailNetwork);
  }

  // ── Rail network overlay ──
  let railLayer = null;
  let railLoaded = false;
  let railVisible = false;

  async function toggleRailNetwork() {
    const btn = $('btnRail');
    if (!map) return;

    if (!railLoaded) {
      btn.textContent = 'Lade…';
      btn.disabled = true;
      try {
        const resp = await fetch('assets/db_streckennetz.geojson');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const geojson = await resp.json();
        railLayer = L.geoJSON(geojson, {
          style: (feature) => {
            const art = (feature.properties.bahnart || '').toLowerCase();
            const isHaupt = art.includes('hauptbahn') || art.includes('fernbahn');
            return {
              color: '#dc2626',
              weight: isHaupt ? 3 : 1.5,
              opacity: isHaupt ? 0.8 : 0.5,
              dashArray: isHaupt ? null : '6 4',
            };
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties;
            layer.bindPopup(`
              <div class="popup-title">Strecke ${p.strecke_nr}</div>
              <div class="popup-row"><span>Kurzname</span><span>${esc(p.strecke_ku)}</span></div>
              <div class="popup-row"><span>Bahnart</span><span>${esc(p.bahnart)}</span></div>
              <div class="popup-row"><span>Elektrifiz.</span><span>${esc(p.elektrifiz)}</span></div>
              <div class="popup-row"><span>Gleise</span><span>${esc(p.gleisanzah)}</span></div>
              <div class="popup-row"><span>km</span><span>${esc(p.von_km_l)} – ${esc(p.bis_km_l)}</span></div>
            `, { maxWidth: 280 });
          },
        });
        railLoaded = true;
      } catch (err) {
        btn.textContent = 'Streckennetz';
        btn.disabled = false;
        showAlert('Streckennetz konnte nicht geladen werden: ' + err.message);
        return;
      }
      btn.disabled = false;
    }

    railVisible = !railVisible;
    if (railVisible) {
      railLayer.addTo(map);
      btn.classList.add('active');
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg> Streckennetz';
    } else {
      map.removeLayer(railLayer);
      btn.classList.remove('active');
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg> Streckennetz';
    }
  }

  function switchTiles(name) {
    Object.keys(tileLayers).forEach(k => map.removeLayer(tileLayers[k]));
    tileLayers[name].addTo(map);
    document.querySelectorAll('.map-tiles-btn').forEach(b => b.classList.remove('active'));
    $('btn' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
  }

  function renderMap(results, epsgCode) {
    initMap();
    map.invalidateSize(); // ensure container size is re-measured after visibility change
    markersLayer.clearLayers();

    const validPoints = results.filter(r => r.backLat != null);
    if (validPoints.length === 0) return;

    const def = EPSG_DEFS[epsgCode];
    const icon = L.divIcon({
      className: '',
      html: `<div style="width:10px;height:10px;border-radius:50%;background:#1e40af;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.4);"></div>`,
      iconSize: [10, 10],
      iconAnchor: [5, 5],
      popupAnchor: [0, -8],
    });

    const bounds = [];
    for (const r of validPoints) {
      // Use back-transformed coordinates (GK→WGS84) so transformation errors are visible on map
      bounds.push([r.backLat, r.backLon]);
      const popup = L.popup({ maxWidth: 280 }).setContent(`
        <div class="popup-title">${esc(r.punktnummer)}</div>
        <div class="popup-row"><span>Rechtswert</span><span>${esc(r.rechtswert)}</span></div>
        <div class="popup-row"><span>Hochwert</span><span>${esc(r.hochwert)}</span></div>
        ${r.hoehe ? `<div class="popup-row"><span>Höhe</span><span>${esc(r.hoehe)} m</span></div>` : ''}
        <div class="popup-row"><span>Art</span><span>${esc(r.art)}${r.selectedCode != null ? ' → ' + r.selectedCode : ''}</span></div>
        ${r.bemerkung ? `<div class="popup-row"><span>Bemerkung</span><span>${esc(r.bemerkung)}</span></div>` : ''}
        ${r.delta != null ? `<div class="popup-row"><span>Δ Rücktransf.</span><span class="${r.delta < 1 ? 'delta-ok' : r.delta < 10 ? 'delta-warn' : 'delta-err'}">${r.delta.toFixed(3)} mm</span></div>` : ''}
        <div style="margin-top:6px;font-size:0.75rem;color:#94a3b8;">EPSG:${esc(epsgCode)} · Zone ${def.zone}</div>
        <div style="font-size:0.75rem;color:#94a3b8;">GPS: ${r.lat.toFixed(6)}°N, ${r.lon.toFixed(6)}°E</div>
        <div style="font-size:0.75rem;color:#94a3b8;">GK→WGS84: ${r.backLat.toFixed(6)}°N, ${r.backLon.toFixed(6)}°E</div>
      `);
      L.marker([r.backLat, r.backLon], { icon }).addTo(markersLayer).bindPopup(popup);
    }

    map.fitBounds(L.latLngBounds(bounds), { padding: [40, 40], maxZoom: 17 });
  }

  // ── Download ──
  downloadBtn.addEventListener('click', () => {
    if (!convertedData) return;

    let sep = (() => {
      const v = separatorSelect.value;
      if (v === '\\t') return '\t';
      if (v === ',') return ',';
      return ';';
    })();
    const decSep = decimalSelect.value;
    const useCode = codeConvertToggle.checked;

    // Auto-resolve conflict: comma as both column and decimal separator
    if (sep === ',' && decSep === ',') sep = ';';

    function fmtDec(val) {
      const s = String(val ?? '');
      return decSep === ',' ? s.replace(/\./g, ',') : s;
    }

    const header = ['Punktnummer', 'Rechtswert', 'Hochwert', 'Höhe', 'Art', 'Bemerkung'].join(sep);
    const rows = convertedData.map(r => {
      const artVal = useCode && r.selectedCode != null ? String(r.selectedCode) : r.art;
      return [r.punktnummer, fmtDec(r.rechtswert), fmtDec(r.hochwert), fmtDec(r.hoehe), artVal, r.bemerkung]
        .map(v => escapeCSVField(v, sep))
        .join(sep);
    });

    const bom = '\uFEFF';
    const csv = bom + header + '\r\n' + rows.join('\r\n') + '\r\n';

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vermessungspunkte_EPSG${epsgSelect.value}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
})();
</script>

</body>
</html>
